# 真珠貝を開いて

問題を表層的に捉えるのでなく、
問題の本質をつかみ、
きちんと問題定義してから
問題解決しましょうというお話。

本章の問題は、基本的には以下の課題をネチネチと解いていく感じ。

## 課題

800+下７桁の無料電話番号のソート

* 入力：10^7までの数値を含んだファイル。数値の重複はない
* 出力：入力をソートした一覧
* 条件：ディスク容量あり。メモリ1MBまで。

## Q1. ライブラリ付属のソート関数を使って問題を解く

課題をメモリの制約を考慮せずに標準ライブラリのソートを使って解く。

`src/lib_sort.c`

## Q2. and, or, shift演算を使ったビット列の実装方法

32-bit integerの各ビットにデータを格納する方法を考える。

たとえば2が存在するということをビット列で表すと、  
`0000 0000 0000 0000 0000 0000 0000 0100`  
のようになる。

これをand, or, shift演算を用いて表現する。

`src/bit_array.c`

## Q3. ビットソートを実装し問題1のソートと比較する

課題をビット列を使ったソートを用いて解決し、  
速度を問題１のソートと比較する。

<table>
  <tr> <td> </td> <td>ライブラリソート</td> <td>ビットソート</td> </tr>
  <tr> <td>実行速度</td> <td>2.1秒</td> <td>0.6秒</td> </tr>
</table>

`src/bit_sort.c`

## Q4. nより小さいk個の重複のないソートされていない整数をどのように生成するか

まず、0..n-1までの数値が並んでいる配列を作成し（ソートされている配列）、  
任意の位置の数値をスワップすればいい。

今回はpythonでrandom.shuffleという便利なメソッドがあったので、pythonで作成した。

`src/make_sample.py`

## Q5. ビットソートは実はメモリを1.25MB使うが、ガチで1MBしか使えない場合どうするか

分割してソートしてく。

例えば、  
`[4, 5, 12, 3, 10, 8, 7, 9, 6, 2, 11, 1]`  
をソートするときに10個ずつしかソートできない場合。

10までの数値をまずはソートする。
`[1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [12, 11]`

次に11, 12をソートする
`[4, 5, 12, 3, 10, 8, 7, 9, 6, 2], [11, 12]`

ソートを合計2回してるので2倍の計算量。

## Q6. 重複が10回まである場合どうやって解くか。またその時のメモリ使用量はどれくらいか

10回分カウントしたいので、1つの数値で4ビット使う。  
例えば、2が3回、6が5回出現した場合は、以下のような表現になる。  
なるほどー

<table>
<tr> <td>7</td> <td>6</td> <td>5</td> <td>4</td> <td>3</td> <td>2</td> <td>1</td> <td>0</td> </tr>
<tr> <td>0000</td> <td>0101</td> <td>0000</td> <td>0000</td> <td>0000</td> <td>0011</td> <td>0000</td> <td>0000</td> </tr>
</table>


## Q7. どのようなエラーチェックをすべきか

* 重複データが誤入力された場合
* 0未満n以上の数値が入力された場合
* 数値以外のデータが入力された場合

ファイル読み込み時にエラー検知し、
そのときにエラーを吐きプログラムを終了させる。  
そのときにエラーデータの数値を出力する。

数値以外のデータはwarningを吐きスキップがいいかも。

他のエラーチェックとしては、

* 入力値がひとつもない場合
* 入力データに空行が含まれる場合

などが考えられる。これらもwarning & skipかな。

`src/error_check.c`

## Q8. 無料電話の上三桁が800以外にも877, 888ができた。

この場合も1MBのメモリでソートして、  
さらに、電話番号がすでに登録されているかを素早く引けるようなシステムを考える。

1) 1MBのメモリでソート  
 800を0, 877を1, 888を2にして下７桁とがっちゃんこ。  
そうすると3億未満の数値でソートできるのでintとして扱える。  
これを800万ずつ(1MB=800万ビット)ソートする。

2) 素早く引けるようにする  
 まず最初の3桁でディレクトリ(800, 877, 888)でディレクトリを作成、
その下に次の3桁のディレクトリを作成。  
そして最後の4桁を1ファイルに入れて、2分探索もしくは該当するビットを探す  
 この方法だと全部を読み込んで2文探索するより早いかと。

## Q9. 配列のメモリの初期化を遅延させたい

大きな配列の初期化にはコストがかかる。  
そこで、配列の要素に初めてアクセスするときに初期化したい。

結論からいうと、  
fromとtoという配列、topという整数があれば実現できるらしい。  
それぞれどのような数値が入っているかというと、  
`
from[i] = top
to[from[i]] = i
topはto配列の初期化済み個数
`

表で書くとこんな感じ。dataは実際に初期化したい配列。

<table>
<tr> <th> </th> <td>0</td> <td>1</td> <td>2</td> <td>3</td> <td>4</td> <td>5</td> <td>6</td> <td>7</td> <td>8</td> <td>9</td> </tr>
<tr> <th>data</th> <td> </td> <td>済</td> <td> </td> <td>済</td> <td> </td> <td> </td> <td> </td> <td> </td> <td>済</td> <td>済</td> </tr>
<tr> <th>from</th> <td> </td> <td>3</td> <td> </td> <td>1</td> <td> </td> <td> </td> <td> </td> <td> </td> <td>2</td> <td>0</td> </tr>
<tr> <th>to</th> <td>9</td> <td>3</td> <td>8</td> <td>1</td> <td> </td> <td> </td> <td> </td> <td> </td> <td></td> <td></td> </tr>
</table>

でtop=4。

順を追って行くと、

1. data[9]が初期化される。その際、from[9]に0、to[0]に9が入りtop++
2. data[3]が初期化される。その際、from[3]に1、to[1]に3が入りtop++
3. data[8]が初期化される。その際、from[8]に2、to[2]に8が入りtop++
4. data[1]が初期化される。その際、from[1]に3、to[3]に1が入りtop++


ここで、data[1]にアクセスがあったとする。
すると、

1. from[1]を見る。
2. 3が入っているのでtopと比較。現時点でtop=4なのでto[3]を見る。from[i] &ge; topなら未初期化
3. to[3]には1が入っているのでiと一致。data[i]は初期化されていることがわかる


次に、data[5]にアクセスが有ったとする。

1. from[5]を見る。
2. 未初期化なので何が入っているかわからない。topより小さい値(たとえば1)が入ってるとすると・・・(top以上なら前述のとおり未初期化確定)
3. to[1]には3が入っている。iとは不一致。なので未初期化確定

といった感じのようです。

知らなかったら思いつかない気がする。  
以下のプロセスで考えることができたら思いつくのかな・・・

1. 絶対にここまでは初期化されているってわかる配列が必要(toのこと)
2. でそいつがどこまで初期化されているか知りたい(top)
3. そいつにどの要素が初期化されているかの情報を入れる(from)

## Q10. 電話で注文を受け、注文をお店で渡すシステムのお店の効率的な顧客管理方法

* 注文は電話で受けます。
* お客さんと電話番号は1:1対応
* お客さんが来たら、ものをすぐに出したい。

10x10のマスを作成し
電話番号下２桁のマスに注文票を入れていく方式でやると早い。

ハッシュマップ方式。衝突しても同じマスに注文票を突っ込んでいけばいい。  
考えた人かしこいなー


## Q11. 工場で引いたCADの図面を40キロ離れた試験場に安く送りたい

図面の送付に１日あたり100ドルかかっているらしい。  
これを安く送りたい。

* ネットを敷設し電子データを送る
* 工場を試験上の横に立てる。

が何年でペイするかという問題かとおもいきや・・・

* 伝書鳩を送る

が正解らしい。  
んーまーたしかに安くつきそうだけど、その発想は一生出てこない気がする。

## Q12. 宇宙で文字を書く

アメリカは百万ドルかけて特別なペンを作成したが、  
一方でロシア(ソ連)は安く解決したがどのように解決したか？

鉛筆を使った。  
たぶんアメリカは"宇宙でペンを使うには"という問題定義をし、  
ロシアは"宇宙で文字を書くには"という問題定義をしたんだろうと思う。

問題定義を正確にすることが大事という話ですね。
